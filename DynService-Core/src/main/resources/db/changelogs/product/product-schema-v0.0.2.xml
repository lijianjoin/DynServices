<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">

    <changeSet author="ismart2" id="product-schema-v0.0.2">

        <!-- ProductEntity -->
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="product_type"
                              schemaName="product_schema"
                              tableName="product"/>


        <!-- add foreignKeys for executed_process_step_id of product-->
        <dropForeignKeyConstraint baseTableName="product"
                                  baseTableSchemaName="product_schema"
                                  constraintName="fk_product_planned_process_step_id"/>

        <addForeignKeyConstraint baseTableSchemaName="product_schema"
                                 baseTableName="product"
                                 baseColumnNames="planned_process_step_id"
                                 constraintName="fk_product_executed_process_step_id"
                                 referencedTableName="executed_process_step"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="product_schema"/>

        <dropForeignKeyConstraint baseTableName="product"
                                  baseTableSchemaName="product_schema"
                                  constraintName="fk_product_planned_process_step_routine_id"/>
        <!-- add foreignKeys for executed_process_step_routine_id of product-->
        <addForeignKeyConstraint baseTableSchemaName="product_schema"
                                 baseTableName="product"
                                 baseColumnNames="planned_process_step_routine_id"
                                 constraintName="fk_product_executed_process_step_routine_id"
                                 referencedTableName="executed_process_step_routine"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="product_schema"/>

        <!-- PlannedProcessEntity -->
        <addNotNullConstraint columnDataType="uuid"
                              schemaName="product_schema"
                              tableName="planned_process"
                              columnName="product_id"
        />
        <addNotNullConstraint columnDataType="varchar(255)"
                              schemaName="product_schema"
                              tableName="planned_process"
                              columnName="name"
        />

        <!-- PlannedProcessStepEntity -->
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="name"
                              schemaName="product_schema"
                              tableName="planned_process_step"/>
        <addNotNullConstraint columnDataType="int"
                              columnName="sequence"
                              schemaName="product_schema"
                              tableName="planned_process_step"/>

        <!-- PlannedProcessStepRoutineEntity -->
        <addNotNullConstraint columnDataType="uuid"
                              columnName="planned_process_step_id"
                              schemaName="product_schema"
                              tableName="planned_process_step_routine"/>
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="name"
                              schemaName="product_schema"
                              tableName="planned_process_step_routine"/>
        <addNotNullConstraint columnDataType="int"
                              columnName="sequence"
                              schemaName="product_schema"
                              tableName="planned_process_step_routine"/>
        <addNotNullConstraint columnDataType="uuid"
                              columnName="workplace_type_id"
                              schemaName="product_schema"
                              tableName="planned_process_step_routine"/>
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="routine_service_name"
                              schemaName="product_schema"
                              tableName="planned_process_step_routine"/>
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="version"
                              schemaName="product_schema"
                              tableName="planned_process_step_routine"/>

        <!-- ExecutedProcessEntity -->
        <addNotNullConstraint columnDataType="uuid"
                              columnName="product_id"
                              schemaName="product_schema"
                              tableName="executed_process"/>
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="name"
                              schemaName="product_schema"
                              tableName="executed_process"/>

        <!-- ExecutedProcessStepEntity -->
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="name"
                              schemaName="product_schema"
                              tableName="executed_process_step"/>
        <addNotNullConstraint columnDataType="int"
                              columnName="sequence"
                              schemaName="product_schema"
                              tableName="executed_process_step"/>
        <addNotNullConstraint columnDataType="uuid"
                              columnName="executed_process_id"
                              schemaName="product_schema"
                              tableName="executed_process_step"/>

        <!-- ExecutedProcessStepRoutineEntity -->
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="name"
                              schemaName="product_schema"
                              tableName="executed_process_step_routine"/>
        <addNotNullConstraint columnDataType="int"
                              columnName="sequence"
                              schemaName="product_schema"
                              tableName="executed_process_step_routine"/>
        <addNotNullConstraint columnDataType="uuid"
                              columnName="workplace_type_id"
                              schemaName="product_schema"
                              tableName="executed_process_step_routine"/>
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="routine_service_name"
                              schemaName="product_schema"
                              tableName="executed_process_step_routine"/>
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="version"
                              schemaName="product_schema"
                              tableName="executed_process_step_routine"/>
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="status"
                              schemaName="product_schema"
                              tableName="executed_process_step_routine"/>

        <!-- ParameterEntity -->
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="name"
                              schemaName="product_schema"
                              tableName="parameters"/>
        <addNotNullConstraint columnDataType="json"
                              columnName="values"
                              schemaName="product_schema"
                              tableName="parameters"/>
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="description"
                              schemaName="product_schema"
                              tableName="parameters"/>

        <!-- ProductRelationEntity -->
        <addNotNullConstraint columnDataType="uuid"
                              columnName="product_id"
                              schemaName="product_schema"
                              tableName="product_relation"/>
        <addNotNullConstraint columnDataType="uuid"
                              columnName="component_id"
                              schemaName="product_schema"
                              tableName="product_relation"/>

        <!-- ResultEntity -->
        <addNotNullConstraint columnDataType="uuid"
                              columnName="product_id"
                              schemaName="product_schema"
                              tableName="result"/>
        <addNotNullConstraint columnDataType="uuid"
                              columnName="executed_process_step_routine_id"
                              schemaName="product_schema"
                              tableName="result"/>


        <!-- MeasurementEntity -->
        <addNotNullConstraint columnDataType="uuid"
                              columnName="product_id"
                              schemaName="product_schema"
                              tableName="measurement"/>
        <addNotNullConstraint columnDataType="uuid"
                              columnName="executed_process_step_routine_id"
                              schemaName="product_schema"
                              tableName="measurement"/>
        <addNotNullConstraint columnDataType="varchar(255)"
                              columnName="name"
                              schemaName="product_schema"
                              tableName="measurement"/>
        <addNotNullConstraint columnDataType="json"
                              columnName="values"
                              schemaName="product_schema"
                              tableName="measurement"/>

        <!-- ProductWorkplaceEntity -->
        <addNotNullConstraint columnDataType="uuid"
                              columnName="product_id"
                              schemaName="product_schema"
                              tableName="product_workplace"/>
        <addNotNullConstraint columnDataType="uuid"
                              columnName="workplace_id"
                              schemaName="product_schema"
                              tableName="product_workplace"/>
        <addNotNullConstraint columnDataType="timestamp"
                              columnName="connection_timestamp"
                              schemaName="product_schema"
                              tableName="product_workplace"/>
        <addNotNullConstraint columnDataType="boolean"
                              columnName="active"
                              schemaName="product_schema"
                              tableName="product_workplace"/>
    </changeSet>

    <changeSet author="ismart2" id="alter-table-names-v0.0.1">
        <renameColumn columnDataType="uuid"
                      newColumnName="last_executed_process_step_id"
                      oldColumnName="planned_process_step_id"
                      schemaName="product_schema"
                      tableName="product"/>
        <renameColumn columnDataType="uuid"
                      newColumnName="last_executed_process_step_routine_id"
                      oldColumnName="planned_process_step_routine_id"
                      schemaName="product_schema"
                      tableName="product"/>
        <renameColumn columnDataType="varchar(255)"
                      newColumnName="type"
                      oldColumnName="product_type"
                      schemaName="product_schema"
                      tableName="product"/>
    </changeSet>
</databaseChangeLog>