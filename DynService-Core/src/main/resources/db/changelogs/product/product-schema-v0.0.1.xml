<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.1.xsd">


    <changeSet author="ismart2" id="product-schema-v0.0.1">
        <!-- ProductEntity -->
        <createTable remarks="The Product information"
                     schemaName="product_schema"
                     tableName="product">
            <column name="id" type="uuid">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="serial_number" type="varchar(255)">
                <constraints nullable="false" primaryKey="false"/>
            </column>
            <column name="product_type_id" type="uuid">

                <constraints foreignKeyName="fk_product_type_id"
                             referencedTableSchemaName="product_type_schema"
                             referencedTableName="product_type"
                             referencedColumnNames="id"
                             nullable="false"
                             primaryKey="false"
                />
            </column>
            <!-- foreignKeys are added at the end of the document. Needed dependency-wise-->
            <column name="planned_process_step_id" type="uuid">
            </column>
            <!-- foreignKeys are added at the end of the document. Needed dependency-wise-->
            <column name="planned_process_step_routine_id" type="uuid">
            </column>

            <column name="product_type" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
        </createTable>

        <!-- PlannedProcessEntity -->
        <createTable remarks="The Planned Process information"
                     schemaName="product_schema"
                     tableName="planned_process">
            <column name="id" type="uuid">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints foreignKeyName="fk_planned_process_entity_product_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="product"
                             referencedColumnNames="id"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
        </createTable>

        <!-- PlannedProcessStepEntity -->
        <createTable remarks="The Planned Process Step information"
                     schemaName="product_schema"
                     tableName="planned_process_step">
            <column name="id" type="uuid">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="planned_process_id" type="uuid">
                <constraints
                        primaryKey="false"
                        foreignKeyName="fk_planned_process_step_planned_process_id"
                        referencedTableSchemaName="product_schema"
                        referencedTableName="planned_process"
                        referencedColumnNames="id"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
            <column name="sequence" type="int">
                <constraints primaryKey="false"/>
            </column>
        </createTable>

        <!-- PlannedProcessStepRoutineEntity -->
        <createTable remarks="The Planned Process Step Routine information"
                     schemaName="product_schema"
                     tableName="planned_process_step_routine">
            <column name="id" type="uuid">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="planned_process_step_id" type="uuid">
                <constraints foreignKeyName="fk_planned_process_step_routine_planned_process_step_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="planned_process_step"
                             referencedColumnNames="id"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
            <column name="sequence" type="int">
                <constraints primaryKey="false"/>
            </column>
            <column name="workplace_type_id" type="uuid">
                <constraints foreignKeyName="fk_planned_process_step_routine_workplace_type_id"
                             referencedTableSchemaName="workplace_schema"
                             referencedTableName="workplace_type"
                             referencedColumnNames="id"/>

            </column>
            <column name="routine_service_name" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
            <column name="version" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
        </createTable>

        <!-- ExecutedProcessEntity -->
        <createTable remarks="The Executed Process information"
                     schemaName="product_schema"
                     tableName="executed_process">
            <column name="id" type="uuid">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints foreignKeyName="fk_executed_process_product_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="product"
                             referencedColumnNames="id"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
        </createTable>

        <!-- ExecutedProcessStepEntity -->
        <createTable remarks="The Executed Process Step information"
                     schemaName="product_schema"
                     tableName="executed_process_step">
            <column name="id" type="uuid">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="executed_process_id" type="uuid">
                <constraints foreignKeyName="fk_executed_process_step_executed_process_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="executed_process"
                             referencedColumnNames="id"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
            <column name="sequence" type="int">
                <constraints primaryKey="false"/>
            </column>
        </createTable>

        <!-- ExecutedProcessStepRoutineEntity -->
        <createTable remarks="The Executed Process Step Routine information"
                     schemaName="product_schema"
                     tableName="executed_process_step_routine">
            <column name="id" type="uuid">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="executed_process_step_id" type="uuid">
                <constraints foreignKeyName="fk_executed_process_step_routine_executed_process_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="executed_process_step"
                             referencedColumnNames="id"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
            <column name="sequence" type="int">
                <constraints primaryKey="false"/>
            </column>
            <column name="workplace_type_id" type="uuid">
                <constraints
                        foreignKeyName="fk_executed_process_step_routine_workplace_type_id"
                        referencedTableSchemaName="workplace_schema"
                        referencedTableName="workplace_type"
                        referencedColumnNames="id"/>

            </column>
            <column name="routine_service_name" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
            <column name="version" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
            <column name="status" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
        </createTable>

        <!-- Parameters -->
        <createTable remarks="The Parameters information"
                     schemaName="product_schema"
                     tableName="parameters">
            <column name="id" type="uuid">
                <constraints primaryKey="true"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints foreignKeyName="fk_parameters_product_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="product"
                             referencedColumnNames="id"/>
            </column>

            <column name="planned_process_id" type="uuid">
                <constraints foreignKeyName="fk_parameters_planned_process_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="planned_process"
                             referencedColumnNames="id"/>
            </column>


            <column name="planned_process_step_id" type="uuid">
                <constraints foreignKeyName="fk_parameters_planned_process_step_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="planned_process_step"
                             referencedColumnNames="id"/>
            </column>

            <column name="planned_process_step_routine_id" type="uuid">
                <constraints foreignKeyName="fk_parameters_planned_process_step_routine_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="planned_process_step_routine"
                             referencedColumnNames="id"/>
            </column>

            <column name="name" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>

            <column name="values" type="json">
                <constraints primaryKey="false"/>
            </column>
            <column name="description" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
        </createTable>


        <!-- ProductRelationEntity -->
        <createTable remarks="The Product Relation information"
                     schemaName="product_schema"
                     tableName="product_relation">
            <column name="id" type="uuid">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints foreignKeyName="fk_product_relation_product_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="product"
                             referencedColumnNames="id"/>
            </column>
            <column name="component_id" type="uuid">
                <constraints foreignKeyName="fk_product_relation_component_product_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="product"
                         referencedColumnNames="id"/>
            </column>
        </createTable>

        <!-- ResultEntity -->
        <createTable remarks="The Result information"
                     schemaName="product_schema"
                     tableName="result">
            <column name="id" type="uuid">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints foreignKeyName="fk_result_product_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="product"
                             referencedColumnNames="id"/>
            </column>
            <column name="executed_process_step_routine_id" type="uuid">
                <constraints foreignKeyName="fk_result_executed_process_step_routine_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="executed_process_step_routine"
                             referencedColumnNames="id"/>
            </column>
        </createTable>

        <!-- MeasurementEntity -->
        <createTable remarks="The Result information"
                     schemaName="product_schema"
                     tableName="measurement">
            <column name="id" type="uuid">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints foreignKeyName="fk_measurement_product_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="product"
                             referencedColumnNames="id"/>
            </column>
            <column name="executed_process_step_routine_id" type="uuid">
                <constraints foreignKeyName="fk_measurement_executed_process_step_routine_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="executed_process_step_routine"
                             referencedColumnNames="id"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints primaryKey="false"/>
            </column>
            <column name="values" type="json">
                <constraints primaryKey="false"/>
            </column>
        </createTable>

        <!-- ProductWorkplaceEntity -->
        <createTable remarks="The Result information"
                     schemaName="product_schema"
                     tableName="product_workplace">
            <column name="id" type="uuid">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="product_id" type="uuid">
                <constraints foreignKeyName="fk_product_workplace_product_id"
                             referencedTableSchemaName="product_schema"
                             referencedTableName="product"
                             referencedColumnNames="id"/>
            </column>
            <column name="workplace_id" type="uuid">
                <constraints foreignKeyName="fk_product_workplace_workplace_id"
                             referencedTableSchemaName="workplace_schema"
                             referencedTableName="workplace"
                             referencedColumnNames="id"/>
            </column>
            <column name="connection_timestamp" type="timestamp">
                <constraints primaryKey="false"/>
            </column>
            <column name="disconnection_timestamp" type="timestamp">
                <constraints primaryKey="false"/>
            </column>
            <column name="active" type="boolean">
                <constraints primaryKey="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet author="ismart2" id="product-foreign-keys-v0.0.1">
        <!-- add foreignKeys for planned_process_step_id of product-->
        <addForeignKeyConstraint baseTableSchemaName="product_schema"
                                 baseTableName="product"
                                 baseColumnNames="planned_process_step_id"
                                 constraintName="fk_product_planned_process_step_id"
                                 referencedTableName="planned_process_step"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="product_schema"/>

        <!-- add foreignKeys for planned_process_step_routine_id of product-->
        <addForeignKeyConstraint baseTableSchemaName="product_schema"
                                 baseTableName="product"
                                 baseColumnNames="planned_process_step_routine_id"
                                 constraintName="fk_product_planned_process_step_routine_id"
                                 referencedTableName="planned_process_step_routine"
                                 referencedColumnNames="id"
                                 referencedTableSchemaName="product_schema"/>
    </changeSet>
</databaseChangeLog>